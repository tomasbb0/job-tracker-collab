<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker (Collaborative)</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; 
            max-width: min(1500px, 95vw); 
            margin: 0 auto; 
            padding: clamp(20px, 3vw, 40px);
            font-size: clamp(12px, 1.1vw, 13px);
            color: #000;
            background: #fff;
            line-height: 1.5;
        }
        h1 { font-weight: 600; font-size: 28px; margin-bottom: 4px; letter-spacing: -0.5px; }
        h2 { font-weight: 600; font-size: 14px; letter-spacing: -0.3px; margin-bottom: 16px; }
        .subtitle { color: #888; font-size: 13px; margin-bottom: 24px; font-weight: 400; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0; margin-bottom: 32px; border-bottom: 1px solid #e5e5e5; }
        .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 13px; color: #888; border-bottom: 2px solid transparent; margin-bottom: -1px; font-weight: 500; transition: all 0.2s; }
        .tab.active { color: #000; border-bottom-color: #000; }
        .tab:hover { color: #000; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Presence */
        .presence-bar { background: #fafafa; padding: 12px 16px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; border: 1px solid #f0f0f0; }
        .presence-label { font-size: 12px; color: #888; font-weight: 500; }
        .user-badge { display: inline-flex; align-items: center; gap: 6px; background: #fff; padding: 6px 12px; border-radius: 100px; font-size: 12px; border: 1px solid #e5e5e5; font-weight: 500; }
        .user-dot { width: 6px; height: 6px; background: #00c853; border-radius: 50%; }
        .you-badge { background: #000; color: #fff; border-color: #000; }
        .you-badge .user-dot { background: #fff; }
        
        /* Toolbar */
        .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #000; color: #fff; }
        .btn-primary:hover { background: #333; transform: translateY(-1px); }
        .btn-secondary { background: #fff; color: #000; border: 1px solid #e5e5e5; }
        .btn-secondary:hover { background: #fafafa; border-color: #ccc; }
        .sync-status { font-size: 12px; color: #00c853; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .sync-dot { width: 6px; height: 6px; background: #00c853; border-radius: 50%; }
        .sync-saving { color: #ff9800; }
        .sync-saving .sync-dot { background: #ff9800; }
        
        /* Tables */
        table { border-collapse: collapse; width: 100%; }
        th { background: #fafafa; font-weight: 600; text-align: left; padding: 12px 16px; border-bottom: 1px solid #e5e5e5; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; }
        td { padding: 12px 16px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; }
        tr:hover { background: #fafafa; }
        tr:last-child td { border-bottom: none; }
        
        /* Inputs */
        select, input[type="text"] { padding: 8px 12px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 13px; background: #fff; width: 100%; transition: all 0.2s; font-family: inherit; }
        select:focus, input[type="text"]:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        select { cursor: pointer; }
        .company-input { font-weight: 600; }
        
        /* Buttons */
        .delete-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; padding: 4px 8px; transition: all 0.2s; border-radius: 4px; }
        .delete-btn:hover { color: #000; background: #f5f5f5; }
        
        /* Apply link cell layout */
        .apply-link-cell { display: flex; align-items: center; gap: 8px; }
        .apply-link-cell input { flex: 1; }
        .open-link-btn { background: #000; border: none; color: #fff; cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .open-link-btn:hover { background: #333; transform: translateY(-1px); }
        .open-link-btn svg { width: 14px; height: 14px; }
        
        /* SVG Icons */
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .icon svg { width: 16px; height: 16px; }
        
        /* Priority tag - clickable */
        .priority { background: #000; color: #fff; font-size: 9px; padding: 3px 8px; border-radius: 4px; margin-left: 8px; font-weight: 600; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s; }
        .priority:hover { background: #333; transform: scale(1.05); }
        .priority-btn { background: transparent; border: 1px dashed #ccc; color: #999; font-size: 9px; padding: 3px 8px; border-radius: 4px; margin-left: 8px; cursor: pointer; transition: all 0.2s; }
        .priority-btn:hover { border-color: #000; color: #000; }
        
        /* Years experience */
        .years-input { width: 60px !important; text-align: center; }
        
        /* Status colors - minimal */
        .status-not-started { background: #fff; }
        .status-waiting-referral { background: #fffbeb; }
        .status-applied { background: #f0f9ff; }
        .status-interview { background: #f0fdf4; }
        .status-rejected { background: #fef2f2; }
        .status-offer { background: #ecfdf5; }
        
        /* History */
        .history-item { padding: 16px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .history-item:hover { background: #fafafa; }
        .history-item:last-child { border-bottom: none; }
        .history-time { color: #888; font-size: 11px; margin-top: 4px; }
        .history-user { font-weight: 600; color: #000; }
        .history-action { color: #666; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 40px; border-radius: 16px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .modal-content h2 { margin-bottom: 8px; font-size: 24px; }
        .modal-content p { color: #888; margin-bottom: 24px; }
        .modal-content input { width: 100%; padding: 14px 16px; font-size: 15px; border: 1px solid #e5e5e5; border-radius: 10px; margin-bottom: 16px; font-family: inherit; }
        .modal-content input:focus { border-color: #000; outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        
        /* Profile */
        .profile { background: #fafafa; padding: 20px 24px; margin-bottom: 32px; border-radius: 12px; font-size: 13px; border: 1px solid #f0f0f0; }
        .profile p { margin: 4px 0; color: #666; }
        .profile strong { color: #000; font-weight: 600; }
        
        /* Layout */
        .tables-container { display: flex; gap: 40px; flex-wrap: wrap; }
        .positions-section { flex: 2; min-width: min(600px, 100%); overflow-x: auto; }
        .referrals-section { flex: 1; min-width: min(320px, 100%); background: #fafafa; padding: 24px; border-radius: 12px; border: 1px solid #f0f0f0; height: fit-content; overflow-x: auto; }
        .referrals-section h2 { margin-top: 0; }
        .referrals-section table { background: #fff; border-radius: 8px; overflow: hidden; }
        .referrals-section th { background: #fff; }
        
        /* Connection status */
        .connection-lost { background: #fef2f2; color: #dc2626; padding: 12px; text-align: center; font-size: 12px; display: none; border-radius: 8px; margin-bottom: 16px; font-weight: 500; }
        .debug-panel { background: #fafafa; border: 1px solid #e5e5e5; padding: 12px 16px; margin-bottom: 16px; border-radius: 8px; font-size: 11px; font-family: 'SF Mono', Monaco, monospace; max-height: 150px; overflow-y: auto; display: none; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ccc; }
        
        /* Resizable columns */
        th.resizable { position: relative; }
        th.resizable::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s;
        }
        th.resizable:hover::after { background: #ddd; }
        th.resizing::after { background: #000 !important; }
        table { table-layout: fixed; min-width: 100%; }
        td, th { overflow: hidden; text-overflow: ellipsis; }
        td:first-child, td:nth-child(2) { overflow: visible; white-space: normal; }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            body { padding: 20px 15px; }
            .tables-container { flex-direction: column; gap: 20px; }
            .positions-section, .referrals-section { min-width: 100%; }
            h1 { font-size: clamp(20px, 5vw, 28px); }
        }
        @media (min-width: 1920px) {
            body { max-width: 90vw; }
        }
        
        /* Filter button */
        .filter-btn { 
            background: none; 
            border: none; 
            color: #888; 
            cursor: pointer; 
            padding: 4px 6px; 
            border-radius: 4px; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center;
        }
        .filter-btn:hover { background: #f0f0f0; color: #000; }
        .filter-btn.active { color: #000; background: #e8e8e8; }
        .filter-btn svg { width: 12px; height: 12px; }
        
        /* Filter dropdown modal */
        .filter-modal { 
            display: none; 
            position: fixed; 
            z-index: 2000; 
            background: #fff; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            min-width: 250px; 
            max-width: 350px; 
        }
        .filter-modal.show { display: block; }
        .filter-modal-header { 
            padding: 12px 16px; 
            border-bottom: 1px solid #e5e5e5; 
            font-weight: 600; 
            font-size: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .filter-modal-content { 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 8px;
        }
        .filter-option { 
            padding: 8px 12px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            font-size: 12px;
        }
        .filter-option:hover { background: #f5f5f5; border-radius: 4px; }
        .filter-option input[type="checkbox"] { cursor: pointer; }
        .filter-sort-buttons {
            padding: 8px 12px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 8px;
        }
        .filter-sort-buttons button {
            flex: 1;
            padding: 6px 10px;
            font-size: 11px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-sort-buttons button:hover { background: #f5f5f5; }
        .filter-sort-buttons button.active { background: #000; color: #fff; border-color: #000; }
        /* Filter button */
        .filter-btn { 
            background: none; 
            border: none; 
            color: #888; 
            cursor: pointer; 
            padding: 4px 6px; 
            border-radius: 4px; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center;
        }
        .filter-btn:hover { background: #f0f0f0; color: #000; }
        .filter-btn.active { color: #000; background: #e8e8e8; }
        .filter-btn svg { width: 12px; height: 12px; }
        
        /* Filter dropdown modal */
        .filter-modal { 
            display: none; 
            position: fixed; 
            z-index: 2000; 
            background: #fff; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            min-width: 250px; 
            max-width: 350px; 
        }
        .filter-modal.show { display: block; }
        .filter-modal-header { 
            padding: 12px 16px; 
            border-bottom: 1px solid #e5e5e5; 
            font-weight: 600; 
            font-size: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .filter-modal-content { 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 8px;
        }
        .filter-option { 
            padding: 8px 12px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            font-size: 12px;
        }
        .filter-option:hover { background: #f5f5f5; border-radius: 4px; }
        .filter-option input[type="checkbox"] { cursor: pointer; }
        .filter-sort-buttons {
            padding: 8px 12px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 8px;
        }
        .filter-sort-buttons button {
            flex: 1;
            padding: 6px 10px;
            font-size: 11px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-sort-buttons button:hover { background: #f5f5f5; }
        .filter-sort-buttons button.active { background: #000; color: #fff; border-color: #000; }
    </style>
</head>
<body>

<!-- Name Entry Modal -->
<div class="modal show" id="nameModal">
    <div class="modal-content">
        <h2><svg style="width:28px;height:28px;vertical-align:middle;margin-right:8px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg>Welcome</h2>
        <p style="color: #666; margin-bottom: 20px;">Enter your name so others know who's editing</p>
        <input type="text" id="nameInput" placeholder="Your name (e.g., Madalena)" autofocus>
        <button class="btn btn-primary" onclick="setUserName()" style="width: 100%; padding: 12px;">Join Document</button>
    </div>
</div>

<!-- Filter Modal -->
<div class="filter-modal" id="filterModal">
    <div class="filter-modal-header">Filter Column</div>
    <div class="filter-modal-content"></div>
    <div class="filter-sort-buttons"></div>
</div>

<div class="connection-lost" id="connectionLost">
    <svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Connection lost. Trying to reconnect...
</div>

<div class="debug-panel" id="debugPanel"></div>

<h1>Job Application Tracker</h1>
<p class="subtitle">TomÃ¡s Batalha | Collaborative Document</p>

<!-- Who's Online -->
<div class="presence-bar">
    <span class="presence-label"><svg style="width:8px;height:8px;vertical-align:middle;margin-right:6px" viewBox="0 0 8 8"><circle cx="4" cy="4" r="4" fill="#00c853"/></svg>Online now:</span>
    <div id="onlineUsers"></div>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab active" onclick="showTab('positions')"><svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>Positions & Referrals</button>
    <button class="tab" onclick="showTab('history')"><svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Change History</button>
</div>

<!-- Positions Tab -->
<div class="tab-content active" id="tab-positions">
    <div class="profile">
        <p><strong>Background:</strong> Google (LCS), Amazon, EY, Pairwire (Co-Founder)</p>
        <p><strong>Education:</strong> NUS Singapore, Rotterdam, Nova SBE</p>
        <p><strong>Languages:</strong> Portuguese, English, Spanish</p>
        <p><strong>Target:</strong> Sales, BD, SDR, BDR, Account Management | Dublin, London, Amsterdam, Madrid, Lisbon</p>
    </div>

    <div class="toolbar">
        <button class="btn btn-primary" onclick="addPosition()">+ Add Position</button>
        <button class="btn btn-secondary" onclick="cleanDuplicates()" style="background: #dc3545; color: #fff; border: none;">ðŸ§¹ Remove Duplicates & Bad Links</button>
        <span class="sync-status" id="syncStatus"><span class="sync-dot"></span> Connecting...</span>
    </div>

    <div class="tables-container">
        <div class="positions-section">
            <h2 style="font-size: 16px; margin-bottom: 10px;"><svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Positions</h2>
            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;"></th>
                        <th style="width: 100px;" class="filterable" data-column="company" onclick="toggleSort('company')">Company <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('company')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                        <th style="min-width: 280px;" class="filterable" data-column="role" onclick="toggleSort('role')">Role <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('role')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                        <th style="width: 90px;" class="filterable" data-column="location" onclick="toggleSort('location')">Location <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('location')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                        <th style="width: 55px;" class="filterable" data-column="yearsExp" onclick="toggleSort('yearsExp')">Yrs Exp <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('yearsExp')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                        <th style="width: 100px;" class="filterable" data-column="link" onclick="toggleSort('link')">Apply Link <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('link')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                        <th style="width: 100px;" class="filterable" data-column="status" onclick="toggleSort('status')">Status <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('status')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                        <th class="filterable" data-column="notes" onclick="toggleSort('notes')">Notes <button class="filter-btn" onclick="event.stopPropagation(); openFilterModal('notes')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg></button></th>
                    </tr>
                </thead>
                <tbody id="positionsBody"></tbody>
            </table>
        </div>

        <div class="referrals-section">
            <h2 style="font-size: 16px; margin-bottom: 10px;"><svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>Company Referrals</h2>
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Referral Contacts</th>
                        <th style="width: 30px;"></th>
                    </tr>
                </thead>
                <tbody id="referralsBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- History Tab -->
<div class="tab-content" id="tab-history">
    <h2 style="font-size: 16px; margin-bottom: 15px;"><svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Change History</h2>
    <div id="historyList" style="max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
        <p style="padding: 20px; color: #999; text-align: center;">Loading history...</p>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyAF36Th9wAoWMAvj0mVAw4GDdpkcx9sPVc",
    authDomain: "job-tracker-tomas.firebaseapp.com",
    databaseURL: "https://job-tracker-tomas-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "job-tracker-tomas",
    storageBucket: "job-tracker-tomas.firebasestorage.app",
    messagingSenderId: "360707138428",
    appId: "1:360707138428:web:543adb9605d2fbd702faf9"
};

// Initialize Firebase
let db = null;
let currentUser = null;
let userId = 'user_' + Math.random().toString(36).substr(2, 9);
let positionKeys = [];

function debug(msg) {
    console.log('[DEBUG]', msg);
    const panel = document.getElementById('debugPanel');
    const time = new Date().toLocaleTimeString();
    panel.innerHTML = `[${time}] ${msg}<br>` + panel.innerHTML;
}

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    debug('âœ“ Firebase initialized');
} catch (e) {
    debug('âœ— Firebase error: ' + e.message);
}

// ============================================
// USER & PRESENCE
// ============================================
function setUserName() {
    const name = document.getElementById('nameInput').value.trim();
    if (!name) {
        alert('Please enter your name');
        return;
    }
    currentUser = name;
    localStorage.setItem('jobTrackerUserName', name);
    document.getElementById('nameModal').classList.remove('show');
    
    debug('User: ' + name);
    
    if (db) {
        setupPresence();
        setupListeners();
        initializeDataIfNeeded();
    } else {
        debug('No Firebase - demo mode');
        loadDemoData();
    }
}

function setupPresence() {
    const presenceRef = db.ref('presence/' + userId);
    const connectedRef = db.ref('.info/connected');
    
    connectedRef.on('value', (snap) => {
        debug('Connected: ' + snap.val());
        if (snap.val() === true) {
            presenceRef.set({
                name: currentUser,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            presenceRef.onDisconnect().remove();
            document.getElementById('connectionLost').style.display = 'none';
            document.getElementById('syncStatus').innerHTML = '<span class="sync-dot"></span> Connected & syncing';
            document.getElementById('syncStatus').className = 'sync-status';
        } else {
            document.getElementById('connectionLost').style.display = 'block';
        }
    });
    
    db.ref('presence').on('value', (snap) => {
        const users = snap.val() || {};
        debug('Online users: ' + Object.values(users).map(u => u.name).join(', '));
        renderOnlineUsers(users);
    });
}

function renderOnlineUsers(users) {
    const container = document.getElementById('onlineUsers');
    container.innerHTML = '';
    
    Object.entries(users).forEach(([id, user]) => {
        const isYou = id === userId;
        const badge = document.createElement('span');
        badge.className = 'user-badge' + (isYou ? ' you-badge' : '');
        badge.innerHTML = `<span class="user-dot"></span>${user.name}${isYou ? ' (you)' : ''}`;
        container.appendChild(badge);
    });
}

// ============================================
// DATA INITIALIZATION
// ============================================
function initializeDataIfNeeded() {
    db.ref('positions').once('value', (snap) => {
        if (!snap.exists()) {
            debug('Initializing default data...');
            loadDefaultPositions();
        } else {
            debug('âœ“ Found ' + Object.keys(snap.val()).length + ' positions');
        }
    }).catch(e => {
        debug('âœ— Data init error: ' + e.message);
    });
}

function loadDefaultPositions() {
    // 1. Get current positions properly
    db.ref('positions').once('value').then((snapshot) => {
        const currentData = snapshot.val() || {};
        const currentPositions = Object.values(currentData);
        
        // 2. Helper to create a unique signature for a position
        const getSig = (p) => `${p.company.toLowerCase().trim()}|${p.role.toLowerCase().trim()}`;
        const existingSigs = new Set(currentPositions.map(getSig));
        
        // 3. Filter defaults
        const defaults = getDefaultPositions();
        let addedCount = 0;
        let skippedCount = 0;

        defaults.forEach((pos) => {
            if (!existingSigs.has(getSig(pos))) {
                db.ref('positions').push(pos);
                addedCount++;
            } else {
                skippedCount++;
            }
        });

        // 4. Feedback
        if (addedCount > 0 || skippedCount > 0) {
            const msg = `âœ… Added ${addedCount} new jobs.\n(Skipped ${skippedCount} duplicates)`;
            alert(msg);
            logHistory(`added ${addedCount} new jobs (skipped ${skippedCount} duplicates)`);
            debug(msg);
        } else {
            alert('No new jobs to add (all already exist).');
        }
    });
}

function cleanDuplicates() {
    if (!confirm('This will REMOVE duplicate entries and jobs with generic/search links. Continue?')) return;
    showSaving();
    
    db.ref('positions').once('value').then((snapshot) => {
        const data = snapshot.val() || {};
        const keys = Object.keys(data);
        const positions = keys.map(k => ({...data[k], _key: k}));
        
        // Track seen signatures and keys to delete
        const seen = new Set();
        const toDelete = [];
        
        // Bad link patterns (generic search/careers pages)
        const badPatterns = [
            'search=', 'keyword=', 'keywords=', 'q=', 'query=',
            '/search?', '/jobs?', '/results?', '/requisitions?',
            'location=Dublin', 'location=London', 'location=Amsterdam',
            '/careers/applications/jobs/results/', 'careers.google.com',
            'about/careers/applications', 'careers.salesforce.com/en/jobs',
            'jobs.careers.microsoft.com', 'careers.oracle.com/jobs',
            'amazon.jobs/en/search', 'metacareers.com/jobs',
            'linkedin.com/jobs/search', 'pinterestcareers.com/en/jobs',
            'careers.snap.com/jobs', 'careers.tiktok.com',
            'jobs.booking.com/careers', 'stripe.com/jobs/search',
            'palantir.com/careers/open-positions'
        ];
        
        positions.forEach(pos => {
            const sig = `${(pos.company||'').toLowerCase().trim()}|${(pos.role||'').toLowerCase().trim()}`;
            const link = pos.link || '';
            
            // Check if link is generic (contains search params)
            const isGenericLink = badPatterns.some(p => link.includes(p));
            
            if (seen.has(sig)) {
                // Duplicate - mark for deletion
                toDelete.push(pos._key);
            } else if (isGenericLink) {
                // Generic link - mark for deletion
                toDelete.push(pos._key);
            } else {
                seen.add(sig);
            }
        });
        
        // Delete marked positions
        const deletePromises = toDelete.map(key => db.ref('positions/' + key).remove());
        
        Promise.all(deletePromises).then(() => {
            showSaved();
            const msg = `ðŸ§¹ Cleaned up ${toDelete.length} entries (duplicates + generic links).`;
            alert(msg);
            logHistory(`cleaned ${toDelete.length} duplicate/generic entries`);
        });
    });
}

// ============================================
// REAL-TIME LISTENERS
// ============================================
function setupListeners() {
    debug('Setting up listeners...');
    
    // Positions listener
    db.ref('positions').on('value', (snap) => {
        const data = snap.val() || {};
        positionKeys = Object.keys(data);
        const positions = positionKeys.map(key => ({ ...data[key], _key: key }));
        debug('Positions sync: ' + positions.length + ' items');
        renderPositions(positions);
        updateReferralsTable(positions);
    }, (error) => {
        debug('âœ— Positions listener error: ' + error.message);
    });
    
    // Referrals listener
    db.ref('referrals').on('value', (snap) => {
        window.companyReferrals = snap.val() || {};
        debug('Referrals sync');
        const positions = [];
        document.querySelectorAll('#positionsBody tr').forEach(row => {
            const input = row.querySelector('.company-input');
            if (input) positions.push({ company: input.value });
        });
        if (positions.length > 0) {
            updateReferralsTable(positions);
        }
    }, (error) => {
        debug('âœ— Referrals listener error: ' + error.message);
    });
    
    // History listener
    db.ref('history').orderByChild('timestamp').limitToLast(50).on('value', (snap) => {
        const history = [];
        snap.forEach(child => {
            history.push({ id: child.key, ...child.val() });
        });
        renderHistory(history.reverse());
    });
}

function loadDemoData() {
    renderPositions(getDefaultPositions());
    updateReferralsTable(getDefaultPositions());
    renderOnlineUsers({ [userId]: { name: currentUser } });
}

// ============================================
// POSITIONS
// ============================================
function renderPositions(positions) {
    allPositions = positions; // Save for filtering
    const tbody = document.getElementById('positionsBody');
    tbody.innerHTML = '';
    
    positions.forEach((pos) => {
        const key = pos._key || '';
        const tr = document.createElement('tr');
        tr.className = 'status-' + (pos.status || 'not-started');
        tr.dataset.key = key;
        const priorityHtml = pos.priority 
            ? `<span class="priority" onclick="togglePriority('${key}', false)" title="Click to remove TOP">TOP</span>`
            : `<button class="priority-btn" onclick="togglePriority('${key}', true)" title="Mark as TOP">+ TOP</button>`;
        tr.innerHTML = `
            <td><button class="delete-btn" onclick="deletePosition('${key}')">Ã—</button></td>
            <td><input type="text" class="company-input" value="${escapeHtml(pos.company || '')}" onchange="updatePosition('${key}', 'company', this.value)">${priorityHtml}</td>
            <td><input type="text" class="role-input" value="${escapeHtml(pos.role || '')}" onchange="updatePosition('${key}', 'role', this.value)"></td>
            <td><input type="text" class="location-input" value="${escapeHtml(pos.location || '')}" onchange="updatePosition('${key}', 'location', this.value)"></td>
            <td><input type="text" class="years-input" value="${escapeHtml(pos.yearsExp || '')}" onchange="updatePosition('${key}', 'yearsExp', this.value)" placeholder="0-3"></td>
            <td><div class="apply-link-cell"><input type="text" class="link-input" value="${escapeHtml(pos.link || '')}" onchange="updatePosition('${key}', 'link', this.value)"><button class="open-link-btn" onclick="openLink(this)" title="Open link"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></button></div></td>
            <td>
                <select class="status-select" onchange="updatePosition('${key}', 'status', this.value)">
                    <option value="not-started" ${pos.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                    <option value="waiting-referral" ${pos.status === 'waiting-referral' ? 'selected' : ''}>Waiting for Referral</option>
                    <option value="applied" ${pos.status === 'applied' ? 'selected' : ''}>Applied</option>
                    <option value="interview" ${pos.status === 'interview' ? 'selected' : ''}>Interview</option>
                    <option value="rejected" ${pos.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    <option value="offer" ${pos.status === 'offer' ? 'selected' : ''}>Offer</option>
                </select>
            </td>
            <td><input type="text" class="notes-input" value="${escapeHtml(pos.notes || '')}" onchange="updatePosition('${key}', 'notes', this.value)"></td>
        `;
        tbody.appendChild(tr);
    });
}

function togglePriority(key, value) {
    if (!key || !db) return;
    showSaving();
    db.ref('positions/' + key + '/priority').set(value)
        .then(() => {
            debug('âœ“ Priority toggled');
            logHistory(value ? 'marked position as TOP' : 'removed TOP from position');
            showSaved();
        })
        .catch(e => debug('âœ— Priority toggle error: ' + e.message));
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function addPosition() {
    if (!db) return;
    
    showSaving();
    const newPos = {
        company: '',
        role: '',
        location: '',
        yearsExp: '',
        link: '',
        status: 'not-started',
        notes: '',
        priority: false,
        createdAt: Date.now()
    };
    
    db.ref('positions').push(newPos)
        .then(() => {
            debug('âœ“ Position added');
            logHistory('added a new position');
            showSaved();
        })
        .catch(e => debug('âœ— Add error: ' + e.message));
}

function updatePosition(key, field, value) {
    if (!key || !db) return;
    
    showSaving();
    debug('Updating: ' + field);
    
    db.ref('positions/' + key + '/' + field).set(value)
        .then(() => {
            debug('âœ“ Updated ' + field);
            logHistory(`changed ${field}`);
            showSaved();
        })
        .catch(e => debug('âœ— Update error: ' + e.message));
}

function deletePosition(key) {
    if (!key || !confirm('Delete this position?')) return;
    
    showSaving();
    db.ref('positions/' + key).remove()
        .then(() => {
            debug('âœ“ Deleted');
            logHistory('deleted a position');
            showSaved();
        })
        .catch(e => debug('âœ— Delete error: ' + e.message));
}

// ============================================
// REFERRALS
// ============================================
window.companyReferrals = {};

function updateReferralsTable(positions) {
    const companies = [...new Set(positions.map(p => p.company).filter(c => c && c.trim()))].sort();
    const tbody = document.getElementById('referralsBody');
    tbody.innerHTML = '';
    
    companies.forEach(company => {
        const safeCompany = company.replace(/[.#$\/\[\]]/g, '_');
        const refs = window.companyReferrals[safeCompany] || [];
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight: 500; vertical-align: top; padding-top: 12px;">${escapeHtml(company)}</td>
            <td>
                <div class="referral-list">
                    ${(Array.isArray(refs) ? refs : []).map((ref, i) => `
                        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <input type="text" value="${escapeHtml(ref)}" placeholder="linkedin.com/in/..." onchange="updateReferral('${safeCompany}', ${i}, this.value)">
                            <button class="delete-btn" onclick="removeReferral('${safeCompany}', ${i})">Ã—</button>
                        </div>
                    `).join('')}
                </div>
            </td>
            <td style="vertical-align: top;">
                <button class="btn btn-secondary" onclick="addReferral('${safeCompany}')" style="padding: 4px 8px; font-size: 11px;">+</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function addReferral(company) {
    if (!window.companyReferrals[company]) {
        window.companyReferrals[company] = [];
    }
    window.companyReferrals[company].push('');
    
    if (db) {
        showSaving();
        db.ref('referrals/' + company).set(window.companyReferrals[company])
            .then(() => showSaved());
    }
}

function updateReferral(company, index, value) {
    if (!window.companyReferrals[company]) {
        window.companyReferrals[company] = [];
    }
    window.companyReferrals[company][index] = value;
    
    if (db) {
        showSaving();
        db.ref('referrals/' + company).set(window.companyReferrals[company])
            .then(() => showSaved());
    }
}

function removeReferral(company, index) {
    if (window.companyReferrals[company]) {
        window.companyReferrals[company].splice(index, 1);
        if (db) {
            showSaving();
            db.ref('referrals/' + company).set(window.companyReferrals[company])
                .then(() => showSaved());
        }
    }
}

// ============================================
// HISTORY
// ============================================
function logHistory(action) {
    if (!db || !currentUser) return;
    db.ref('history').push({
        user: currentUser,
        action: action,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}

function renderHistory(history) {
    const container = document.getElementById('historyList');
    if (!history.length) {
        container.innerHTML = '<p style="padding: 20px; color: #999; text-align: center;">No changes yet</p>';
        return;
    }
    container.innerHTML = history.map(item => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        return `
            <div class="history-item">
                <span class="history-user">${escapeHtml(item.user)}</span>
                <span class="history-action">${escapeHtml(item.action)}</span>
                <div class="history-time">${timeStr}</div>
            </div>
        `;
    }).join('');
}

// ============================================
// UI
// ============================================
function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

function showSaving() {
    const status = document.getElementById('syncStatus');
    status.className = 'sync-status sync-saving';
    status.innerHTML = '<span class="sync-dot"></span> Saving...';
}

function showSaved() {
    const status = document.getElementById('syncStatus');
    status.className = 'sync-status';
    status.innerHTML = '<span class="sync-dot"></span> Saved <svg style="width:12px;height:12px;vertical-align:middle;margin-left:2px" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
    setTimeout(() => {
        status.innerHTML = '<span class="sync-dot"></span> Connected & syncing';
    }, 1500);
}

function openLink(btn) {
    const input = btn.previousElementSibling;
    const url = input.value.trim();
    if (url) {
        // Add https if missing
        const fullUrl = url.startsWith('http') ? url : 'https://' + url;
        window.open(fullUrl, '_blank');
    } else {
        alert('No link entered');
    }
}

// ============================================
// DEFAULT DATA - ENTRY LEVEL (1-3 YRS ONLY)
// ============================================
function getDefaultPositions() {
    // ONLY verified direct job links - NO search pages
    return [
        {company: "HubSpot", role: "BDR - UKI", location: "Dublin", yearsExp: "0-2", link: "https://www.hubspot.com/careers/jobs/4930717", status: "not-started", notes: "Direct link verified.", priority: true},
        {company: "HubSpot", role: "BDR - Benelux (English)", location: "Dublin", yearsExp: "0-2", link: "https://www.hubspot.com/careers/jobs/5220991", status: "not-started", notes: "Direct link verified.", priority: true},
        {company: "Datadog", role: "Technical Account Manager", location: "Dublin", yearsExp: "2-4", link: "https://careers.datadoghq.com/detail/7555001/", status: "not-started", notes: "Direct link verified.", priority: true},
        {company: "Miro", role: "Commercial Account Executive", location: "Amsterdam", yearsExp: "2-3", link: "https://miro.com/careers/open-positions/5628103003", status: "not-started", notes: "Direct link verified.", priority: true}
    ];
}

// ============================================
// INIT
// ============================================
const savedName = localStorage.getItem('jobTrackerUserName');
if (savedName) {
    document.getElementById('nameInput').value = savedName;
}

document.getElementById('nameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') setUserName();
});

// Triple-click title to show debug
document.querySelector('h1').addEventListener('click', function(e) {
    if (e.detail === 3) {
        const panel = document.getElementById('debugPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
});

// ============================================
// TABLE FILTERING & SORTING
// ============================================
let filterState = {
    sortColumn: null,
    sortDirection: 'asc',
    columnFilters: {}
};

const filterableColumns = ['company', 'role', 'location', 'status'];

function openFilterModal(column) {
    // Get unique values for this column
    const values = [...new Set(allPositions.map(p => p[column] || ''))].sort();
    const modal = document.getElementById('filterModal');
    const header = modal.querySelector('.filter-modal-header');
    const content = modal.querySelector('.filter-modal-content');
    const buttons = modal.querySelector('.filter-sort-buttons');
    
    header.textContent = `Filter: ${column.toUpperCase()}`;
    
    // Build checkbox list
    content.innerHTML = values.map(val => `
        <label class="filter-option">
            <input type="checkbox" data-column="${column}" data-value="${val}" ${filterState.columnFilters[column]?.includes(val) ? 'checked' : ''}>
            <span>${val || '(empty)'}</span>
        </label>
    `).join('');
    
    // Add sort buttons
    buttons.innerHTML = `
        <button onclick="sortColumn('${column}', 'asc')" class="${filterState.sortColumn === column && filterState.sortDirection === 'asc' ? 'active' : ''}">â†‘ Aâ†’Z</button>
        <button onclick="sortColumn('${column}', 'desc')" class="${filterState.sortColumn === column && filterState.sortDirection === 'desc' ? 'active' : ''}">â†“ Zâ†’A</button>
    `;
    
    // Add event listeners to checkboxes
    content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateFilters);
    });
    
    // Position modal
    const rect = event.target.getBoundingClientRect();
    modal.style.top = (rect.bottom + 10) + 'px';
    modal.style.left = rect.left + 'px';
    modal.classList.add('show');
}

function toggleSort(column) {
    if (filterState.sortColumn === column) {
        filterState.sortDirection = filterState.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        filterState.sortColumn = column;
        filterState.sortDirection = 'asc';
    }
    applyFiltersAndSort();
}

function sortColumn(column, direction) {
    filterState.sortColumn = column;
    filterState.sortDirection = direction;
    applyFiltersAndSort();
}

function updateFilters() {
    filterState.columnFilters = {};
    document.querySelectorAll('.filter-modal-content input:checked').forEach(cb => {
        const col = cb.dataset.column;
        const val = cb.dataset.value;
        if (!filterState.columnFilters[col]) filterState.columnFilters[col] = [];
        filterState.columnFilters[col].push(val);
    });
    applyFiltersAndSort();
    localStorage.setItem('tableFilters', JSON.stringify(filterState));
}

function applyFiltersAndSort() {
    let filtered = allPositions;
    
    // Apply column filters
    Object.entries(filterState.columnFilters).forEach(([col, vals]) => {
        if (vals.length > 0) {
            filtered = filtered.filter(p => vals.includes(p[col] || ''));
        }
    });
    
    // Apply sorting
    if (filterState.sortColumn) {
        filtered.sort((a, b) => {
            const aVal = (a[filterState.sortColumn] || '').toString().toLowerCase();
            const bVal = (b[filterState.sortColumn] || '').toString().toLowerCase();
            const cmp = aVal.localeCompare(bVal);
            return filterState.sortDirection === 'asc' ? cmp : -cmp;
        });
    }
    
    renderPositions(filtered);
}

function resetTableFilters() {
    filterState = { sortColumn: null, sortDirection: 'asc', columnFilters: {} };
    document.querySelectorAll('.filter-modal-content input[type="checkbox"]').forEach(cb => cb.checked = false);
    localStorage.removeItem('tableFilters');
    renderPositions(allPositions);
}

// Close filter modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('filterModal');
    if (modal && !modal.contains(e.target) && !e.target.classList.contains('filter-btn')) {
        modal.classList.remove('show');
    }
});

// Load saved filters on startup
window.addEventListener('load', () => {
    const saved = localStorage.getItem('tableFilters');
    if (saved) {
        filterState = JSON.parse(saved);
        // Apply saved filters
        setTimeout(() => applyFiltersAndSort(), 500);
    }
});

// ============================================
// RESIZABLE COLUMNS
// ============================================
function initResizableColumns() {
    const tables = document.querySelectorAll('table');
    
    tables.forEach((table, tableIndex) => {
        const headers = table.querySelectorAll('th');
        const tableId = tableIndex === 0 ? 'positions' : 'referrals';
        
        // Load saved widths
        const savedWidths = JSON.parse(localStorage.getItem(`columnWidths_${tableId}`) || '{}');
        
        headers.forEach((th, colIndex) => {
            // Apply saved width if exists
            if (savedWidths[colIndex]) {
                th.style.width = savedWidths[colIndex] + 'px';
            }
            
            // Make resizable (skip first delete column)
            if (colIndex > 0 || tableIndex === 1) {
                th.classList.add('resizable');
                
                let startX, startWidth;
                
                th.addEventListener('mousedown', function(e) {
                    // Only if clicking the resize handle area (right 5px)
                    const rect = th.getBoundingClientRect();
                    if (e.clientX > rect.right - 10) {
                        e.preventDefault();
                        startX = e.clientX;
                        startWidth = th.offsetWidth;
                        th.classList.add('resizing');
                        
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    }
                });
                
                function onMouseMove(e) {
                    const newWidth = Math.max(40, startWidth + (e.clientX - startX));
                    th.style.width = newWidth + 'px';
                }
                
                function onMouseUp() {
                    th.classList.remove('resizing');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    
                    // Save all column widths for this table
                    const widths = {};
                    headers.forEach((header, idx) => {
                        widths[idx] = header.offsetWidth;
                    });
                    localStorage.setItem(`columnWidths_${tableId}`, JSON.stringify(widths));
                }
            }
        });
    });
}

// Initialize resizable columns after page loads
setTimeout(initResizableColumns, 500);
</script>

</body>
</html>