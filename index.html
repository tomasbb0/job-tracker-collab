<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker (Collaborative)</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; 
            max-width: 1500px; 
            margin: 0 auto; 
            padding: 40px;
            font-size: 13px;
            color: #000;
            background: #fff;
            line-height: 1.5;
        }
        h1 { font-weight: 600; font-size: 28px; margin-bottom: 4px; letter-spacing: -0.5px; }
        h2 { font-weight: 600; font-size: 14px; letter-spacing: -0.3px; margin-bottom: 16px; }
        .subtitle { color: #888; font-size: 13px; margin-bottom: 24px; font-weight: 400; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0; margin-bottom: 32px; border-bottom: 1px solid #e5e5e5; }
        .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 13px; color: #888; border-bottom: 2px solid transparent; margin-bottom: -1px; font-weight: 500; transition: all 0.2s; }
        .tab.active { color: #000; border-bottom-color: #000; }
        .tab:hover { color: #000; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Presence */
        .presence-bar { background: #fafafa; padding: 12px 16px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; border: 1px solid #f0f0f0; }
        .presence-label { font-size: 12px; color: #888; font-weight: 500; }
        .user-badge { display: inline-flex; align-items: center; gap: 6px; background: #fff; padding: 6px 12px; border-radius: 100px; font-size: 12px; border: 1px solid #e5e5e5; font-weight: 500; }
        .user-dot { width: 6px; height: 6px; background: #00c853; border-radius: 50%; }
        .you-badge { background: #000; color: #fff; border-color: #000; }
        .you-badge .user-dot { background: #fff; }
        
        /* Toolbar */
        .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #000; color: #fff; }
        .btn-primary:hover { background: #333; transform: translateY(-1px); }
        .btn-secondary { background: #fff; color: #000; border: 1px solid #e5e5e5; }
        .btn-secondary:hover { background: #fafafa; border-color: #ccc; }
        .sync-status { font-size: 12px; color: #00c853; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .sync-dot { width: 6px; height: 6px; background: #00c853; border-radius: 50%; }
        .sync-saving { color: #ff9800; }
        .sync-saving .sync-dot { background: #ff9800; }
        
        /* Tables */
        table { border-collapse: collapse; width: 100%; }
        th { background: #fafafa; font-weight: 600; text-align: left; padding: 12px 16px; border-bottom: 1px solid #e5e5e5; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; }
        td { padding: 12px 16px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; }
        tr:hover { background: #fafafa; }
        tr:last-child td { border-bottom: none; }
        
        /* Inputs */
        select, input[type="text"] { padding: 8px 12px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 13px; background: #fff; width: 100%; transition: all 0.2s; font-family: inherit; }
        select:focus, input[type="text"]:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        select { cursor: pointer; }
        .company-input { font-weight: 600; }
        
        /* Buttons */
        .delete-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; padding: 4px 8px; transition: all 0.2s; border-radius: 4px; }
        .delete-btn:hover { color: #000; background: #f5f5f5; }
        
        /* Apply link cell layout */
        .apply-link-cell { display: flex; align-items: center; gap: 8px; }
        .apply-link-cell input { flex: 1; }
        .open-link-btn { background: #000; border: none; color: #fff; cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .open-link-btn:hover { background: #333; transform: translateY(-1px); }
        .open-link-btn svg { width: 14px; height: 14px; }
        
        /* SVG Icons */
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .icon svg { width: 16px; height: 16px; }
        
        /* Priority tag - clickable */
        .priority { background: #000; color: #fff; font-size: 9px; padding: 3px 8px; border-radius: 4px; margin-left: 8px; font-weight: 600; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s; }
        .priority:hover { background: #333; transform: scale(1.05); }
        .priority-btn { background: transparent; border: 1px dashed #ccc; color: #999; font-size: 9px; padding: 3px 8px; border-radius: 4px; margin-left: 8px; cursor: pointer; transition: all 0.2s; }
        .priority-btn:hover { border-color: #000; color: #000; }
        
        /* Years experience */
        .years-input { width: 60px !important; text-align: center; }
        
        /* Status colors - minimal */
        .status-not-started { background: #fff; }
        .status-waiting-referral { background: #fffbeb; }
        .status-applied { background: #f0f9ff; }
        .status-interview { background: #f0fdf4; }
        .status-rejected { background: #fef2f2; }
        .status-offer { background: #ecfdf5; }
        
        /* History */
        .history-item { padding: 16px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .history-item:hover { background: #fafafa; }
        .history-item:last-child { border-bottom: none; }
        .history-time { color: #888; font-size: 11px; margin-top: 4px; }
        .history-user { font-weight: 600; color: #000; }
        .history-action { color: #666; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal.hidden { display: none !important; visibility: hidden !important; }
        .modal-content { background: #fff; padding: 40px; border-radius: 16px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .modal-content h2 { margin-bottom: 8px; font-size: 24px; }
        .modal-content p { color: #888; margin-bottom: 24px; }
        .modal-content input { width: 100%; padding: 14px 16px; font-size: 15px; border: 1px solid #e5e5e5; border-radius: 10px; margin-bottom: 16px; font-family: inherit; }
        .modal-content input:focus { border-color: #000; outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        
        /* Profile */
        .profile { background: #fafafa; padding: 20px 24px; margin-bottom: 32px; border-radius: 12px; font-size: 13px; border: 1px solid #f0f0f0; }
        .profile p { margin: 4px 0; color: #666; }
        .profile strong { color: #000; font-weight: 600; }
        
        /* Layout */
        .tables-container { display: flex; gap: 0; flex-wrap: nowrap; }
        .positions-section { flex: 1; min-width: 600px; overflow-x: auto; }
        .resize-divider { width: 8px; background: #f0f0f0; cursor: col-resize; flex-shrink: 0; transition: background 0.2s; }
        .resize-divider:hover, .resize-divider.dragging { background: #ccc; }
        .referrals-section { width: 350px; min-width: 200px; max-width: 500px; background: #fafafa; padding: 24px; border-radius: 0 12px 12px 0; border: 1px solid #f0f0f0; border-left: none; height: fit-content; flex-shrink: 0; }
        .referrals-section h2 { margin-top: 0; }
        .referrals-section table { background: #fff; border-radius: 8px; overflow: hidden; }
        .referrals-section th { background: #fff; }
        
        /* Excel-style column header dropdown */
        .col-header { display: flex; align-items: center; gap: 4px; }
        .col-header-text { flex: 1; cursor: pointer; }
        .col-sort-arrows { display: flex; flex-direction: column; font-size: 8px; line-height: 1; cursor: pointer; opacity: 0.3; }
        .col-sort-arrows:hover { opacity: 1; }
        .col-sort-arrows .active { opacity: 1; color: #000; }
        .col-filter-btn { background: none; border: none; cursor: pointer; padding: 2px 4px; opacity: 0.4; font-size: 11px; }
        .col-filter-btn:hover { opacity: 1; }
        .col-filter-btn.filtered { opacity: 1; color: #0066cc; }
        th:hover .col-filter-btn, th:hover .col-sort-arrows { opacity: 0.7; }
        .col-dropdown { position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px; display: none; }
        .col-dropdown.show { display: block; }
        .col-dropdown-header { padding: 8px 12px; border-bottom: 1px solid #eee; display: flex; gap: 8px; }
        .col-dropdown-header button { padding: 4px 8px; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; background: #fff; cursor: pointer; }
        .col-dropdown-header button:hover { background: #f5f5f5; }
        .col-dropdown-values { max-height: 250px; overflow-y: auto; padding: 4px 0; }
        .col-dropdown-item { padding: 6px 12px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .col-dropdown-item:hover { background: #f5f5f5; }
        .col-dropdown-item input[type="checkbox"] { margin: 0; cursor: pointer; }
        .col-dropdown-apply { padding: 8px 12px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; }
        .col-dropdown-apply button { padding: 6px 16px; font-size: 12px; border: none; border-radius: 4px; background: #000; color: #fff; cursor: pointer; }
        .col-dropdown-apply button:hover { background: #333; }
        
        /* Connection status */
        .connection-lost { background: #fef2f2; color: #dc2626; padding: 12px; text-align: center; font-size: 12px; display: none; border-radius: 8px; margin-bottom: 16px; font-weight: 500; }
        .debug-panel { background: #fafafa; border: 1px solid #e5e5e5; padding: 12px 16px; margin-bottom: 16px; border-radius: 8px; font-size: 11px; font-family: 'SF Mono', Monaco, monospace; max-height: 150px; overflow-y: auto; display: none; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ccc; }
        
        /* Resizable columns */
        th.resizable { position: relative; }
        th.resizable::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s;
        }
        th.resizable:hover::after { background: #ddd; }
        th.resizing::after { background: #000 !important; }
        table { table-layout: fixed; }
        td, th { overflow: hidden; text-overflow: ellipsis; }
        td:first-child, td:nth-child(2) { overflow: visible; white-space: normal; }
    </style>
</head>
<body>

<!-- Early script to define functions before buttons -->
<script>
window.setUserName = function() {
    var nameInput = document.getElementById('nameInput');
    var name = nameInput ? nameInput.value.trim() : '';
    if (!name) {
        alert('Please enter your name');
        return;
    }
    window.currentUser = name;
    localStorage.setItem('jobTrackerUserName', name);
    
    // Close modal
    var modal = document.getElementById('nameModal');
    if (modal) {
        modal.classList.remove('show');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
    }
    
    // Try to call onUserJoined, or set a flag for later
    if (window.onUserJoined) {
        window.onUserJoined(name);
    } else {
        // Firebase script hasn't loaded yet, set flag
        window.pendingUserName = name;
    }
};

// Early stubs - will be replaced by full functions when Firebase loads
window.loadDefaultPositions = function() {
    alert('Please wait for Firebase to connect, then try again.');
};
window.addPosition = function() {
    alert('Please wait for Firebase to connect, then try again.');
};
window.cleanDuplicates = function() {
    alert('Please wait for Firebase to connect, then try again.');
};
</script>

<!-- Name Entry Modal -->
<div class="modal show" id="nameModal">
    <div class="modal-content">
        <h2><svg style="width:28px;height:28px;vertical-align:middle;margin-right:8px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg>Welcome</h2>
        <p style="color: #666; margin-bottom: 20px;">Enter your name so others know who's editing</p>
        <input type="text" id="nameInput" placeholder="Your name (e.g., Madalena)" autofocus>
        <button class="btn btn-primary" onclick="window.setUserName()" style="width: 100%; padding: 12px;">Join Document</button>
    </div>
</div>

<div class="connection-lost" id="connectionLost">
    <svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Connection lost. Trying to reconnect...
</div>

<div class="debug-panel" id="debugPanel"></div>

<h1>Job Application Tracker</h1>
<p class="subtitle">TomÃ¡s Batalha | Collaborative Document</p>

<!-- Who's Online -->
<div class="presence-bar">
    <span class="presence-label"><svg style="width:8px;height:8px;vertical-align:middle;margin-right:6px" viewBox="0 0 8 8"><circle cx="4" cy="4" r="4" fill="#00c853"/></svg>Online now:</span>
    <div id="onlineUsers"></div>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab active" onclick="showTab('positions')"><svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>Positions & Referrals</button>
    <button class="tab" onclick="showTab('history')"><svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Change History</button>
</div>

<!-- Positions Tab -->
<div class="tab-content active" id="tab-positions">
    <div class="profile">
        <p><strong>Background:</strong> Google (LCS), Amazon, EY, Pairwire (Co-Founder)</p>
        <p><strong>Education:</strong> NUS Singapore, Rotterdam, Nova SBE</p>
        <p><strong>Languages:</strong> Portuguese, English, Spanish</p>
        <p><strong>Target:</strong> Sales, BD, SDR, BDR, Account Management | Dublin, London, Amsterdam, Madrid, Lisbon</p>
    </div>

    <div class="toolbar">
        <button class="btn btn-primary" onclick="window.addPosition()">+ Add Position</button>
        <button class="btn btn-secondary" onclick="window.loadDefaultPositions()" style="background: #28a745; color: #fff; border: none;">ðŸ“¥ Load Default Jobs</button>
        <button class="btn btn-secondary" onclick="window.cleanDuplicates()" style="background: #dc3545; color: #fff; border: none;">ðŸ§¹ Remove Duplicates & Bad Links</button>
        <span class="sync-status" id="syncStatus"><span class="sync-dot"></span> Connecting...</span>
    </div>

    <div class="tables-container">
        <div class="positions-section">
            <h2 style="font-size: 16px; margin-bottom: 10px;"><svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Positions</h2>
            <table id="positionsTable">
                <thead>
                    <tr>
                        <th style="width: 30px;"></th>
                        <th style="width: 100px; position: relative;" data-col="company"><div class="col-header"><span class="col-header-text" onclick="sortColumn('company')">Company</span><div class="col-sort-arrows" onclick="sortColumn('company')"><span id="sort-company-asc">â–²</span><span id="sort-company-desc">â–¼</span></div><button class="col-filter-btn" id="filter-btn-company" onclick="toggleColDropdown(event, 'company')">â˜°</button></div><div class="col-dropdown" id="dropdown-company"></div></th>
                        <th style="min-width: 280px; position: relative;" data-col="role"><div class="col-header"><span class="col-header-text" onclick="sortColumn('role')">Role</span><div class="col-sort-arrows" onclick="sortColumn('role')"><span id="sort-role-asc">â–²</span><span id="sort-role-desc">â–¼</span></div><button class="col-filter-btn" id="filter-btn-role" onclick="toggleColDropdown(event, 'role')">â˜°</button></div><div class="col-dropdown" id="dropdown-role"></div></th>
                        <th style="width: 90px; position: relative;" data-col="location"><div class="col-header"><span class="col-header-text" onclick="sortColumn('location')">Location</span><div class="col-sort-arrows" onclick="sortColumn('location')"><span id="sort-location-asc">â–²</span><span id="sort-location-desc">â–¼</span></div><button class="col-filter-btn" id="filter-btn-location" onclick="toggleColDropdown(event, 'location')">â˜°</button></div><div class="col-dropdown" id="dropdown-location"></div></th>
                        <th style="width: 55px; position: relative;" data-col="yearsExp"><div class="col-header"><span class="col-header-text" onclick="sortColumn('yearsExp')">Yrs Exp</span><div class="col-sort-arrows" onclick="sortColumn('yearsExp')"><span id="sort-yearsExp-asc">â–²</span><span id="sort-yearsExp-desc">â–¼</span></div><button class="col-filter-btn" id="filter-btn-yearsExp" onclick="toggleColDropdown(event, 'yearsExp')">â˜°</button></div><div class="col-dropdown" id="dropdown-yearsExp"></div></th>
                        <th style="width: 100px;">Apply Link</th>
                        <th style="width: 100px; position: relative;" data-col="status"><div class="col-header"><span class="col-header-text" onclick="sortColumn('status')">Status</span><div class="col-sort-arrows" onclick="sortColumn('status')"><span id="sort-status-asc">â–²</span><span id="sort-status-desc">â–¼</span></div><button class="col-filter-btn" id="filter-btn-status" onclick="toggleColDropdown(event, 'status')">â˜°</button></div><div class="col-dropdown" id="dropdown-status"></div></th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="positionsBody"></tbody>
            </table>
        </div>

        <div class="resize-divider" id="resizeDivider"></div>
        <div class="referrals-section">
            <h2 style="font-size: 16px; margin-bottom: 10px;"><svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>Company Referrals</h2>
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Referral Contacts</th>
                        <th style="width: 30px;"></th>
                    </tr>
                </thead>
                <tbody id="referralsBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- History Tab -->
<div class="tab-content" id="tab-history">
    <h2 style="font-size: 16px; margin-bottom: 15px;"><svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Change History</h2>
    <div id="historyList" style="max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
        <p style="padding: 20px; color: #999; text-align: center;">Loading history...</p>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ============================================
// MAIN APPLICATION SCRIPT
// ============================================
let db = null;
let currentUser = window.currentUser || null;
let userId = localStorage.getItem('jobTrackerUserId');
if (!userId) {
    userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    localStorage.setItem('jobTrackerUserId', userId);
}
let positionKeys = [];

function debug(msg) {
    console.log('[DEBUG]', msg);
    const panel = document.getElementById('debugPanel');
    if (panel) {
        const time = new Date().toLocaleTimeString();
        panel.innerHTML = `[${time}] ${msg}<br>` + panel.innerHTML;
    }
}

// Called from the early script when user joins
window.onUserJoined = function(name) {
    currentUser = name;
    debug('User joined: ' + name);
    
    if (db) {
        debug('Setting up presence and listeners...');
        setupPresence();
        setupListeners();
        initializeDataIfNeeded();
    } else {
        debug('âœ— Firebase not connected - retrying in 1s...');
        setTimeout(function() {
            if (db) {
                debug('Retry successful, setting up...');
                setupPresence();
                setupListeners();
                initializeDataIfNeeded();
            } else {
                alert('Error: Could not connect to Firebase. Please refresh the page.');
            }
        }, 1000);
    }
};

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyAF36Th9wAoWMAvj0mVAw4GDdpkcx9sPVc",
    authDomain: "job-tracker-tomas.firebaseapp.com",
    databaseURL: "https://job-tracker-tomas-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "job-tracker-tomas",
    storageBucket: "job-tracker-tomas.firebasestorage.app",
    messagingSenderId: "360707138428",
    appId: "1:360707138428:web:543adb9605d2fbd702faf9"
};

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    debug('âœ“ Firebase initialized');
} catch (e) {
    debug('âœ— Firebase error: ' + e.message);
}

// ============================================
// PRESENCE FUNCTIONS
// ============================================
function setupPresence() {
    const presenceRef = db.ref('presence/' + userId);
    const connectedRef = db.ref('.info/connected');
    
    connectedRef.on('value', (snap) => {
        debug('Connected: ' + snap.val());
        if (snap.val() === true) {
            presenceRef.set({
                name: currentUser,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            presenceRef.onDisconnect().remove();
            document.getElementById('connectionLost').style.display = 'none';
            document.getElementById('syncStatus').innerHTML = '<span class="sync-dot"></span> Connected & syncing';
            document.getElementById('syncStatus').className = 'sync-status';
        } else {
            document.getElementById('connectionLost').style.display = 'block';
        }
    });
    
    db.ref('presence').on('value', (snap) => {
        const users = snap.val() || {};
        debug('Online users: ' + Object.values(users).map(u => u.name).join(', '));
        renderOnlineUsers(users);
    });
}

function renderOnlineUsers(users) {
    const container = document.getElementById('onlineUsers');
    container.innerHTML = '';
    
    // Deduplicate users by name (same person in multiple tabs)
    const uniqueUsers = {};
    Object.entries(users).forEach(([id, user]) => {
        const name = user.name;
        if (!uniqueUsers[name] || id === userId) {
            uniqueUsers[name] = { id, user };
        }
    });
    
    Object.entries(uniqueUsers).forEach(([name, {id, user}]) => {
        const isYou = id === userId || user.name === currentUser;
        const badge = document.createElement('span');
        badge.className = 'user-badge' + (isYou ? ' you-badge' : '');
        badge.innerHTML = `<span class="user-dot"></span>${user.name}${isYou ? ' (you)' : ''}`;
        container.appendChild(badge);
    });
}

// ============================================
// DATA INITIALIZATION
// ============================================
function initializeDataIfNeeded() {
    db.ref('positions').once('value', (snap) => {
        const existingCount = snap.exists() ? Object.keys(snap.val()).length : 0;
        debug('âœ“ Found ' + existingCount + ' positions');
        
        // Always load defaults if less than 10 positions
        if (existingCount < 10) {
            debug('Loading default positions...');
            setTimeout(() => loadDefaultPositions(), 500); // Small delay to ensure function is defined
        }
    }).catch(e => {
        debug('âœ— Data init error: ' + e.message);
    });
}

function loadDefaultPositions() {
    if (!db) {
        alert('Not connected to database. Please enter your name and join first.');
        return;
    }
    
    // 1. Get current positions properly
    db.ref('positions').once('value').then((snapshot) => {
        const currentData = snapshot.val() || {};
        const currentPositions = Object.values(currentData);
        
        // 2. Helper to create a unique signature for a position
        const getSig = (p) => `${p.company.toLowerCase().trim()}|${p.role.toLowerCase().trim()}`;
        const existingSigs = new Set(currentPositions.map(getSig));
        
        // 3. Filter defaults
        const defaults = getDefaultPositions();
        let addedCount = 0;
        let skippedCount = 0;

        defaults.forEach((pos) => {
            if (!existingSigs.has(getSig(pos))) {
                db.ref('positions').push(pos);
                addedCount++;
            } else {
                skippedCount++;
            }
        });

        // 4. Feedback
        if (addedCount > 0 || skippedCount > 0) {
            const msg = `âœ… Added ${addedCount} new jobs.\n(Skipped ${skippedCount} duplicates)`;
            alert(msg);
            if (currentUser) logHistory(`added ${addedCount} new jobs (skipped ${skippedCount} duplicates)`);
            debug(msg);
        } else {
            alert('No new jobs to add (all already exist).');
        }
    }).catch(e => {
        alert('Error loading jobs: ' + e.message);
        console.error(e);
    });
}
window.loadDefaultPositions = loadDefaultPositions; // Expose globally

function cleanDuplicates() {
    if (!confirm('This will REMOVE duplicate entries and jobs with generic/search links. Continue?')) return;
    showSaving();
    
    db.ref('positions').once('value').then((snapshot) => {
        const data = snapshot.val() || {};
        const keys = Object.keys(data);
        const positions = keys.map(k => ({...data[k], _key: k}));
        
        // Track seen signatures and keys to delete
        const seen = new Set();
        const toDelete = [];
        
        // Bad link patterns (generic search/careers pages)
        const badPatterns = [
            'search=', 'keyword=', 'keywords=', 'q=', 'query=',
            '/search?', '/jobs?', '/results?', '/requisitions?',
            'location=Dublin', 'location=London', 'location=Amsterdam',
            '/careers/applications/jobs/results/', 'careers.google.com',
            'about/careers/applications', 'careers.salesforce.com/en/jobs',
            'jobs.careers.microsoft.com', 'careers.oracle.com/jobs',
            'amazon.jobs/en/search', 'metacareers.com/jobs',
            'linkedin.com/jobs/search', 'pinterestcareers.com/en/jobs',
            'careers.snap.com/jobs', 'careers.tiktok.com',
            'jobs.booking.com/careers', 'stripe.com/jobs/search',
            'palantir.com/careers/open-positions'
        ];
        
        positions.forEach(pos => {
            const sig = `${(pos.company||'').toLowerCase().trim()}|${(pos.role||'').toLowerCase().trim()}`;
            const link = pos.link || '';
            
            // Check if link is generic (contains search params)
            const isGenericLink = badPatterns.some(p => link.includes(p));
            
            if (seen.has(sig)) {
                // Duplicate - mark for deletion
                toDelete.push(pos._key);
            } else if (isGenericLink) {
                // Generic link - mark for deletion
                toDelete.push(pos._key);
            } else {
                seen.add(sig);
            }
        });
        
        // Delete marked positions
        const deletePromises = toDelete.map(key => db.ref('positions/' + key).remove());
        
        Promise.all(deletePromises).then(() => {
            showSaved();
            const msg = `ðŸ§¹ Cleaned up ${toDelete.length} entries (duplicates + generic links).`;
            alert(msg);
            logHistory(`cleaned ${toDelete.length} duplicate/generic entries`);
        });
    });
}
window.cleanDuplicates = cleanDuplicates; // Expose globally

// ============================================
// REAL-TIME LISTENERS
// ============================================
function setupListeners() {
    debug('Setting up listeners...');
    
    // Positions listener
    db.ref('positions').on('value', (snap) => {
        const data = snap.val() || {};
        positionKeys = Object.keys(data);
        const positions = positionKeys.map(key => ({ ...data[key], _key: key }));
        debug('Positions sync: ' + positions.length + ' items');
        renderPositions(positions);
        updateReferralsTable(positions);
    }, (error) => {
        debug('âœ— Positions listener error: ' + error.message);
    });
    
    // Referrals listener
    db.ref('referrals').on('value', (snap) => {
        window.companyReferrals = snap.val() || {};
        debug('Referrals sync');
        const positions = [];
        document.querySelectorAll('#positionsBody tr').forEach(row => {
            const input = row.querySelector('.company-input');
            if (input) positions.push({ company: input.value });
        });
        if (positions.length > 0) {
            updateReferralsTable(positions);
        }
    }, (error) => {
        debug('âœ— Referrals listener error: ' + error.message);
    });
    
    // History listener
    db.ref('history').orderByChild('timestamp').limitToLast(50).on('value', (snap) => {
        const history = [];
        snap.forEach(child => {
            history.push({ id: child.key, ...child.val() });
        });
        renderHistory(history.reverse());
    });
}

function loadDemoData() {
    renderPositions(getDefaultPositions());
    updateReferralsTable(getDefaultPositions());
    renderOnlineUsers({ [userId]: { name: currentUser } });
}

// ============================================
// POSITIONS
// ============================================
function renderPositions(positions) {
    // Store all positions for filtering
    allPositions = positions;
    applyFilter();
}

function renderPositionsFiltered(positions) {
    const tbody = document.getElementById('positionsBody');
    tbody.innerHTML = '';
    
    positions.forEach((pos) => {
        const key = pos._key || '';
        const tr = document.createElement('tr');
        tr.className = 'status-' + (pos.status || 'not-started');
        tr.dataset.key = key;
        const priorityHtml = pos.priority 
            ? `<span class="priority" onclick="togglePriority('${key}', false)" title="Click to remove TOP">TOP</span>`
            : `<button class="priority-btn" onclick="togglePriority('${key}', true)" title="Mark as TOP">+ TOP</button>`;
        tr.innerHTML = `
            <td><button class="delete-btn" onclick="deletePosition('${key}')">Ã—</button></td>
            <td><input type="text" class="company-input" value="${escapeHtml(pos.company || '')}" onchange="updatePosition('${key}', 'company', this.value)">${priorityHtml}</td>
            <td><input type="text" class="role-input" value="${escapeHtml(pos.role || '')}" onchange="updatePosition('${key}', 'role', this.value)"></td>
            <td><input type="text" class="location-input" value="${escapeHtml(pos.location || '')}" onchange="updatePosition('${key}', 'location', this.value)"></td>
            <td><input type="text" class="years-input" value="${escapeHtml(pos.yearsExp || '')}" onchange="updatePosition('${key}', 'yearsExp', this.value)" placeholder="0-3"></td>
            <td><div class="apply-link-cell"><input type="text" class="link-input" value="${escapeHtml(pos.link || '')}" onchange="updatePosition('${key}', 'link', this.value)"><button class="open-link-btn" onclick="openLink(this)" title="Open link"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></button></div></td>
            <td>
                <select class="status-select" onchange="updatePosition('${key}', 'status', this.value)">
                    <option value="not-started" ${pos.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                    <option value="waiting-referral" ${pos.status === 'waiting-referral' ? 'selected' : ''}>Waiting for Referral</option>
                    <option value="applied" ${pos.status === 'applied' ? 'selected' : ''}>Applied</option>
                    <option value="interview" ${pos.status === 'interview' ? 'selected' : ''}>Interview</option>
                    <option value="rejected" ${pos.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    <option value="offer" ${pos.status === 'offer' ? 'selected' : ''}>Offer</option>
                </select>
            </td>
            <td><input type="text" class="notes-input" value="${escapeHtml(pos.notes || '')}" onchange="updatePosition('${key}', 'notes', this.value)"></td>
        `;
        tbody.appendChild(tr);
    });
}

function togglePriority(key, value) {
    if (!key || !db) return;
    showSaving();
    db.ref('positions/' + key + '/priority').set(value)
        .then(() => {
            debug('âœ“ Priority toggled');
            logHistory(value ? 'marked position as TOP' : 'removed TOP from position');
            showSaved();
        })
        .catch(e => debug('âœ— Priority toggle error: ' + e.message));
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function addPosition() {
    if (!db) return;
    
    showSaving();
    const newPos = {
        company: '',
        role: '',
        location: '',
        yearsExp: '',
        link: '',
        status: 'not-started',
        notes: '',
        priority: false,
        createdAt: Date.now()
    };
    
    db.ref('positions').push(newPos)
        .then(() => {
            debug('âœ“ Position added');
            logHistory('added a new position');
            showSaved();
        })
        .catch(e => debug('âœ— Add error: ' + e.message));
}
window.addPosition = addPosition; // Expose globally

function updatePosition(key, field, value) {
    if (!key || !db) return;
    
    showSaving();
    debug('Updating: ' + field);
    
    db.ref('positions/' + key + '/' + field).set(value)
        .then(() => {
            debug('âœ“ Updated ' + field);
            logHistory(`changed ${field}`);
            showSaved();
        })
        .catch(e => debug('âœ— Update error: ' + e.message));
}

function deletePosition(key) {
    if (!key || !confirm('Delete this position?')) return;
    
    showSaving();
    db.ref('positions/' + key).remove()
        .then(() => {
            debug('âœ“ Deleted');
            logHistory('deleted a position');
            showSaved();
        })
        .catch(e => debug('âœ— Delete error: ' + e.message));
}

// ============================================
// REFERRALS
// ============================================
window.companyReferrals = {};

function updateReferralsTable(positions) {
    const companies = [...new Set(positions.map(p => p.company).filter(c => c && c.trim()))].sort();
    const tbody = document.getElementById('referralsBody');
    tbody.innerHTML = '';
    
    companies.forEach(company => {
        const safeCompany = company.replace(/[.#$\/\[\]]/g, '_');
        const refs = window.companyReferrals[safeCompany] || [];
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight: 500; vertical-align: top; padding-top: 12px;">${escapeHtml(company)}</td>
            <td>
                <div class="referral-list">
                    ${(Array.isArray(refs) ? refs : []).map((ref, i) => `
                        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <input type="text" value="${escapeHtml(ref)}" placeholder="linkedin.com/in/..." onchange="updateReferral('${safeCompany}', ${i}, this.value)">
                            <button class="delete-btn" onclick="removeReferral('${safeCompany}', ${i})">Ã—</button>
                        </div>
                    `).join('')}
                </div>
            </td>
            <td style="vertical-align: top;">
                <button class="btn btn-secondary" onclick="addReferral('${safeCompany}')" style="padding: 4px 8px; font-size: 11px;">+</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function addReferral(company) {
    if (!window.companyReferrals[company]) {
        window.companyReferrals[company] = [];
    }
    window.companyReferrals[company].push('');
    
    if (db) {
        showSaving();
        db.ref('referrals/' + company).set(window.companyReferrals[company])
            .then(() => showSaved());
    }
}

function updateReferral(company, index, value) {
    if (!window.companyReferrals[company]) {
        window.companyReferrals[company] = [];
    }
    window.companyReferrals[company][index] = value;
    
    if (db) {
        showSaving();
        db.ref('referrals/' + company).set(window.companyReferrals[company])
            .then(() => showSaved());
    }
}

function removeReferral(company, index) {
    if (window.companyReferrals[company]) {
        window.companyReferrals[company].splice(index, 1);
        if (db) {
            showSaving();
            db.ref('referrals/' + company).set(window.companyReferrals[company])
                .then(() => showSaved());
        }
    }
}

// ============================================
// HISTORY
// ============================================
function logHistory(action) {
    if (!db || !currentUser) return;
    db.ref('history').push({
        user: currentUser,
        action: action,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}

function renderHistory(history) {
    const container = document.getElementById('historyList');
    if (!history.length) {
        container.innerHTML = '<p style="padding: 20px; color: #999; text-align: center;">No changes yet</p>';
        return;
    }
    container.innerHTML = history.map(item => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        return `
            <div class="history-item">
                <span class="history-user">${escapeHtml(item.user)}</span>
                <span class="history-action">${escapeHtml(item.action)}</span>
                <div class="history-time">${timeStr}</div>
            </div>
        `;
    }).join('');
}

// ============================================
// UI
// ============================================
function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

function showSaving() {
    const status = document.getElementById('syncStatus');
    status.className = 'sync-status sync-saving';
    status.innerHTML = '<span class="sync-dot"></span> Saving...';
}

function showSaved() {
    const status = document.getElementById('syncStatus');
    status.className = 'sync-status';
    status.innerHTML = '<span class="sync-dot"></span> Saved <svg style="width:12px;height:12px;vertical-align:middle;margin-left:2px" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
    setTimeout(() => {
        status.innerHTML = '<span class="sync-dot"></span> Connected & syncing';
    }, 1500);
}

function openLink(btn) {
    const input = btn.previousElementSibling;
    const url = input.value.trim();
    if (url) {
        // Add https if missing
        const fullUrl = url.startsWith('http') ? url : 'https://' + url;
        window.open(fullUrl, '_blank');
    } else {
        alert('No link entered');
    }
}

// ============================================
// DEFAULT DATA - ENTRY LEVEL (1-3 YRS ONLY)
// ============================================
function getDefaultPositions() {
    // 40 Entry-Level Jobs (1-3 years experience) - Sales/BD/SDR/BDR/Account Management
    return [
        // Anthropic (3 roles)
        {company: "Anthropic", role: "Business Development Representative", location: "San Francisco", yearsExp: "1-3", link: "https://www.anthropic.com/careers", status: "not-started", notes: "", priority: true},
        {company: "Anthropic", role: "Sales Development Representative", location: "San Francisco", yearsExp: "1-3", link: "https://www.anthropic.com/careers", status: "not-started", notes: "", priority: true},
        {company: "Anthropic", role: "Account Executive - Enterprise", location: "San Francisco", yearsExp: "2-3", link: "https://www.anthropic.com/careers", status: "not-started", notes: "", priority: true},
        
        // OpenAI (2 roles)
        {company: "OpenAI", role: "Business Development Representative", location: "San Francisco", yearsExp: "0-2", link: "https://openai.com/careers", status: "not-started", notes: "", priority: true},
        {company: "OpenAI", role: "Sales Development Representative", location: "San Francisco", yearsExp: "0-2", link: "https://openai.com/careers", status: "not-started", notes: "", priority: true},
        
        // Google (2 roles)
        {company: "Google", role: "Account Strategist", location: "Dublin", yearsExp: "0-2", link: "https://careers.google.com/", status: "not-started", notes: "", priority: true},
        {company: "Google", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://careers.google.com/", status: "not-started", notes: "", priority: true},
        
        // Microsoft (2 roles)
        {company: "Microsoft", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://careers.microsoft.com/", status: "not-started", notes: "", priority: false},
        {company: "Microsoft", role: "Account Executive", location: "Dublin", yearsExp: "1-3", link: "https://careers.microsoft.com/", status: "not-started", notes: "", priority: false},
        
        // Meta (2 roles)
        {company: "Meta", role: "Client Solutions Manager", location: "Dublin", yearsExp: "1-3", link: "https://www.metacareers.com/", status: "not-started", notes: "", priority: true},
        {company: "Meta", role: "Sales Development Representative", location: "Dublin", yearsExp: "1-3", link: "https://www.metacareers.com/", status: "not-started", notes: "", priority: true},
        
        // Stripe (2 roles)
        {company: "Stripe", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://stripe.com/jobs", status: "not-started", notes: "", priority: true},
        {company: "Stripe", role: "Account Executive", location: "Dublin", yearsExp: "1-3", link: "https://stripe.com/jobs", status: "not-started", notes: "", priority: true},
        
        // Adyen (3 roles)
        {company: "Adyen", role: "Business Development Representative", location: "Amsterdam", yearsExp: "0-2", link: "https://careers.adyen.com/", status: "not-started", notes: "", priority: true},
        {company: "Adyen", role: "Account Manager", location: "Amsterdam", yearsExp: "1-3", link: "https://careers.adyen.com/", status: "not-started", notes: "", priority: true},
        {company: "Adyen", role: "Sales Development Representative", location: "Amsterdam", yearsExp: "0-2", link: "https://careers.adyen.com/", status: "not-started", notes: "", priority: true},
        
        // Databricks (2 roles)
        {company: "Databricks", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://www.databricks.com/company/careers", status: "not-started", notes: "", priority: true},
        {company: "Databricks", role: "Sales Development Representative", location: "Amsterdam", yearsExp: "0-2", link: "https://www.databricks.com/company/careers", status: "not-started", notes: "", priority: true},
        
        // Datadog (3 roles)
        {company: "Datadog", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://careers.datadoghq.com/", status: "not-started", notes: "", priority: true},
        {company: "Datadog", role: "Technical Account Manager", location: "Dublin", yearsExp: "2-3", link: "https://careers.datadoghq.com/detail/7555001/", status: "not-started", notes: "Direct link verified.", priority: true},
        {company: "Datadog", role: "Account Executive", location: "Dublin", yearsExp: "1-3", link: "https://careers.datadoghq.com/", status: "not-started", notes: "", priority: true},
        
        // Snowflake (1 role)
        {company: "Snowflake", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://careers.snowflake.com/", status: "not-started", notes: "", priority: true},
        
        // ServiceNow (2 roles)
        {company: "ServiceNow", role: "Business Development Representative", location: "Dublin", yearsExp: "1-3", link: "https://careers.servicenow.com/", status: "not-started", notes: "", priority: false},
        {company: "ServiceNow", role: "Sales Development Representative", location: "Dublin", yearsExp: "1-3", link: "https://careers.servicenow.com/", status: "not-started", notes: "", priority: false},
        
        // Salesforce (2 roles)
        {company: "Salesforce", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://careers.salesforce.com/", status: "not-started", notes: "", priority: true},
        {company: "Salesforce", role: "Account Executive", location: "Dublin", yearsExp: "1-3", link: "https://careers.salesforce.com/", status: "not-started", notes: "", priority: true},
        
        // Amazon AWS (2 roles)
        {company: "Amazon AWS", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://www.amazon.jobs/", status: "not-started", notes: "", priority: true},
        {company: "Amazon AWS", role: "Account Manager", location: "Dublin", yearsExp: "1-3", link: "https://www.amazon.jobs/", status: "not-started", notes: "", priority: true},
        
        // Palantir (1 role)
        {company: "Palantir", role: "Business Development Representative", location: "London", yearsExp: "0-2", link: "https://www.palantir.com/careers/", status: "not-started", notes: "", priority: true},
        
        // HubSpot (2 roles)
        {company: "HubSpot", role: "BDR - UKI", location: "Dublin", yearsExp: "0-2", link: "https://www.hubspot.com/careers/jobs/4930717", status: "not-started", notes: "Direct link verified.", priority: true},
        {company: "HubSpot", role: "BDR - Benelux (English)", location: "Dublin", yearsExp: "0-2", link: "https://www.hubspot.com/careers/jobs/5220991", status: "not-started", notes: "Direct link verified.", priority: true},
        
        // LinkedIn (1 role)
        {company: "LinkedIn", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://careers.linkedin.com/", status: "not-started", notes: "", priority: false},
        
        // Intercom (1 role)
        {company: "Intercom", role: "Sales Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://www.intercom.com/careers", status: "not-started", notes: "", priority: true},
        
        // Miro (1 role)
        {company: "Miro", role: "Commercial Account Executive", location: "Amsterdam", yearsExp: "2-3", link: "https://miro.com/careers/open-positions/5628103003", status: "not-started", notes: "Direct link verified.", priority: true},
        
        // Notion (1 role)
        {company: "Notion", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://www.notion.so/careers", status: "not-started", notes: "", priority: true},
        
        // Figma (1 role)
        {company: "Figma", role: "Business Development Representative", location: "London", yearsExp: "0-2", link: "https://www.figma.com/careers/", status: "not-started", notes: "", priority: true},
        
        // Airtable (1 role)
        {company: "Airtable", role: "Business Development Representative", location: "London", yearsExp: "0-2", link: "https://www.airtable.com/careers", status: "not-started", notes: "", priority: false},
        
        // Twilio (1 role)
        {company: "Twilio", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://www.twilio.com/company/jobs", status: "not-started", notes: "", priority: false},
        
        // Zendesk (1 role)
        {company: "Zendesk", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://jobs.zendesk.com/", status: "not-started", notes: "", priority: false},
        
        // Atlassian (1 role)
        {company: "Atlassian", role: "Business Development Representative", location: "Amsterdam", yearsExp: "0-2", link: "https://www.atlassian.com/company/careers", status: "not-started", notes: "", priority: false},
        
        // Shopify (1 role)
        {company: "Shopify", role: "Business Development Representative", location: "Dublin", yearsExp: "0-2", link: "https://www.shopify.com/careers", status: "not-started", notes: "", priority: false}
    ];
}

// ============================================
// INIT
// ============================================
const savedName = localStorage.getItem('jobTrackerUserName');
if (savedName) {
    document.getElementById('nameInput').value = savedName;
}

// Auto-join if user has saved name and skip modal
const autoJoinName = savedName || window.currentUser || window.pendingUserName;
if (autoJoinName && db) {
    currentUser = autoJoinName;
    document.getElementById('nameModal').classList.add('hidden');
    document.getElementById('nameModal').style.display = 'none';
    debug('Auto-joining as: ' + currentUser);
    setupPresence();
    setupListeners();
    initializeDataIfNeeded();
}

document.getElementById('nameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') window.setUserName();
});

// Triple-click title to show debug
document.querySelector('h1').addEventListener('click', function(e) {
    if (e.detail === 3) {
        const panel = document.getElementById('debugPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
});

// ============================================
// EXCEL-STYLE COLUMN FILTER & SORT
// ============================================
let currentSort = { column: null, direction: 'asc' };
let allPositions = [];

const statusLabels = {
    'not-started': 'Not Started',
    'waiting-referral': 'Waiting for Referral',
    'applied': 'Applied',
    'interview': 'Interview',
    'rejected': 'Rejected',
    'offer': 'Offer'
};

// Track selected filter values per column (multi-select)
let columnFilterSelections = { company: new Set(), role: new Set(), location: new Set(), status: new Set(), yearsExp: new Set() };

function toggleColDropdown(e, column) {
    e.stopPropagation();
    
    // Close all other dropdowns
    document.querySelectorAll('.col-dropdown').forEach(d => {
        if (d.id !== `dropdown-${column}`) d.classList.remove('show');
    });
    
    const dropdown = document.getElementById(`dropdown-${column}`);
    const isOpen = dropdown.classList.contains('show');
    
    if (isOpen) {
        dropdown.classList.remove('show');
    } else {
        // Build dropdown content
        buildDropdownContent(column);
        dropdown.classList.add('show');
    }
}

function buildDropdownContent(column) {
    const dropdown = document.getElementById(`dropdown-${column}`);
    const uniqueValues = [...new Set(allPositions.map(p => p[column]).filter(v => v && v.toString().trim()))].sort();
    const selected = columnFilterSelections[column];
    
    let html = `
        <div class="col-dropdown-header">
            <button onclick="selectAllFilter('${column}')">Select All</button>
            <button onclick="clearFilter('${column}')">Clear All</button>
        </div>
        <div class="col-dropdown-values">
    `;
    
    uniqueValues.forEach(val => {
        const displayVal = column === 'status' ? (statusLabels[val] || val) : val;
        const isChecked = selected.size === 0 || selected.has(val);
        html += `<div class="col-dropdown-item">
            <input type="checkbox" id="filter-${column}-${escapeHtml(val)}" ${isChecked ? 'checked' : ''} onchange="toggleFilterValue('${column}', '${escapeHtml(val)}', this.checked)">
            <label for="filter-${column}-${escapeHtml(val)}">${escapeHtml(displayVal)}</label>
        </div>`;
    });
    
    html += `</div>
        <div class="col-dropdown-apply">
            <button onclick="applyColumnFilter('${column}')">Apply</button>
        </div>`;
    dropdown.innerHTML = html;
}

function selectAllFilter(column) {
    columnFilterSelections[column] = new Set();
    buildDropdownContent(column);
}

function clearFilter(column) {
    const uniqueValues = [...new Set(allPositions.map(p => p[column]).filter(v => v && v.toString().trim()))];
    // Set to empty means "show all", but for clear we want to uncheck all
    columnFilterSelections[column] = new Set(['__NONE__']); // Special marker for "nothing selected"
    buildDropdownContent(column);
}

function toggleFilterValue(column, value, checked) {
    const selected = columnFilterSelections[column];
    
    // If currently showing all (empty set), initialize with all values
    if (selected.size === 0) {
        const uniqueValues = [...new Set(allPositions.map(p => p[column]).filter(v => v && v.toString().trim()))];
        uniqueValues.forEach(v => selected.add(v));
    }
    
    // Remove special marker if present
    selected.delete('__NONE__');
    
    if (checked) {
        selected.add(value);
    } else {
        selected.delete(value);
    }
}

function applyColumnFilter(column) {
    closeAllDropdowns();
    applyFilter();
    
    // Update filter button to show it's active
    const btn = document.getElementById(`filter-btn-${column}`);
    const selected = columnFilterSelections[column];
    const uniqueValues = [...new Set(allPositions.map(p => p[column]).filter(v => v && v.toString().trim()))];
    
    if (btn) {
        // Filtered if not all values selected
        const isFiltered = selected.size > 0 && selected.size < uniqueValues.length && !selected.has('__NONE__');
        btn.classList.toggle('filtered', isFiltered);
    }
}

function sortColumn(column, direction) {
    // If direction not provided, toggle
    if (!direction) {
        if (currentSort.column === column) {
            direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            direction = 'asc';
        }
    }
    
    currentSort = { column, direction };
    closeAllDropdowns();
    applyFilter();
    
    // Update sort arrow indicators
    document.querySelectorAll('.col-sort-arrows span').forEach(span => {
        span.classList.remove('active');
    });
    const activeArrow = document.getElementById(`sort-${column}-${direction}`);
    if (activeArrow) activeArrow.classList.add('active');
}

function closeAllDropdowns() {
    document.querySelectorAll('.col-dropdown').forEach(d => d.classList.remove('show'));
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.col-dropdown') && !e.target.closest('.col-filter-btn')) {
        closeAllDropdowns();
    }
});

function applyFilter() {
    let filtered = allPositions;
    
    // Apply all column filters (multi-select)
    Object.keys(columnFilterSelections).forEach(col => {
        const selected = columnFilterSelections[col];
        if (selected.size > 0 && !selected.has('__NONE__')) {
            filtered = filtered.filter(p => selected.has((p[col] || '').toString()));
        } else if (selected.has('__NONE__')) {
            filtered = []; // Nothing selected
        }
    });
    });
    
    // Apply current sort
    if (currentSort.column) {
        filtered = sortPositions(filtered, currentSort.column, currentSort.direction);
    }
    
    renderPositionsFiltered(filtered);
}

function sortPositions(positions, column, direction) {
    return [...positions].sort((a, b) => {
        let valA = (a[column] || '').toString().toLowerCase();
        let valB = (b[column] || '').toString().toLowerCase();
        
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
}

// ============================================
// RESIZABLE COLUMNS (Fixed)
// ============================================
function initResizableColumns() {
    const tables = document.querySelectorAll('table');
    
    tables.forEach((table, tableIndex) => {
        const headers = table.querySelectorAll('th');
        const tableId = tableIndex === 0 ? 'positions' : 'referrals';
        
        // Load saved widths
        const savedWidths = JSON.parse(localStorage.getItem(`columnWidths_${tableId}`) || '{}');
        
        headers.forEach((th, colIndex) => {
            // Apply saved width if exists
            if (savedWidths[colIndex]) {
                th.style.width = savedWidths[colIndex] + 'px';
            }
            
            // Make resizable (skip first delete column for positions table)
            if (colIndex > 0 || tableIndex === 1) {
                th.classList.add('resizable');
                
                // Create resize handle
                const handle = document.createElement('div');
                handle.style.cssText = 'position:absolute;right:0;top:0;bottom:0;width:8px;cursor:col-resize;z-index:10;';
                th.style.position = 'relative';
                th.appendChild(handle);
                
                let startX, startWidth;
                
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    th.classList.add('resizing');
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
                
                function onMouseMove(e) {
                    const diff = e.pageX - startX;
                    const newWidth = Math.max(40, startWidth + diff);
                    th.style.width = newWidth + 'px';
                }
                
                function onMouseUp() {
                    th.classList.remove('resizing');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    
                    // Save all column widths for this table
                    const widths = {};
                    headers.forEach((header, idx) => {
                        widths[idx] = header.offsetWidth;
                    });
                    localStorage.setItem(`columnWidths_${tableId}`, JSON.stringify(widths));
                }
            }
        });
    });
    
    // Make referrals section width persistent via drag divider
    const referralsSection = document.querySelector('.referrals-section');
    const divider = document.getElementById('resizeDivider');
    
    if (referralsSection && divider) {
        const savedWidth = localStorage.getItem('referralsSectionWidth');
        if (savedWidth) {
            referralsSection.style.width = savedWidth + 'px';
        }
        
        let startX, startWidth;
        
        divider.addEventListener('mousedown', function(e) {
            e.preventDefault();
            startX = e.pageX;
            startWidth = referralsSection.offsetWidth;
            divider.classList.add('dragging');
            
            document.addEventListener('mousemove', onDividerMove);
            document.addEventListener('mouseup', onDividerUp);
        });
        
        function onDividerMove(e) {
            // Dragging left makes referrals bigger, right makes it smaller
            const diff = startX - e.pageX;
            const newWidth = Math.max(200, Math.min(500, startWidth + diff));
            referralsSection.style.width = newWidth + 'px';
        }
        
        function onDividerUp() {
            divider.classList.remove('dragging');
            document.removeEventListener('mousemove', onDividerMove);
            document.removeEventListener('mouseup', onDividerUp);
            localStorage.setItem('referralsSectionWidth', referralsSection.offsetWidth);
        }
    }
}

// Initialize resizable columns after page loads
setTimeout(initResizableColumns, 500);
</script>

</body>
</html>updated Wed Jan 28 13:37:30 WET 2026
